<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" as="style" type="font/woff2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap');
        
        #loaderOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader {
            position: absolute;
            width: 120px;
            height: 120px;
            top: 150px;
            align-items: center;
            left: 50%;
        }

        .loader svg {
            position: absolute;
            top: 50%;
            left: 50%;
            background-color: rgba(0, 102, 67, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 65px;
            height: 65px;
            transform: translate(-70%, -70%);
            border-radius: 60%;
        }

        .loader:after {
            content: " ";
            display: block;
            width: 55px;
            height: 55px;
            margin: 8px;
            border-radius: 50%;
            border: 10px solid rgba(255, 255, 255, 1);
            border-color: rgba(255, 255, 255, 1) transparent rgba(255, 255, 255, 1) transparent;
            animation: roller 1.2s linear infinite;
        }

        @keyframes roller {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: #FDFAF5;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-container {
            width: 726px;
            height: 435px;
            padding: 20px;
            background-color: #ffffffff;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            margin-left: 20px;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 200px;
            height: 100vh;
            background-color: white;
            color: rgba(0, 102, 67, 1);
            padding-top: 20px;
            box-sizing: border-box;
            z-index: 1000;
            transition: left 0.3s ease;
            border-right: 1px solid #ccc;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            padding-right: 20px;
            border-bottom: 1px solid rgba(0, 102, 67, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar ul li i {
            width: 20px;
            text-align: center;
        }
         
        .sidebar ul li:last-child {
            border-bottom: none;
        }

        .sidebar ul li:hover {
            background-color: #E6F0EC;
        }
        
        .sidebar ul li.active-menu-item {
            background-color: #E6F0EC;
            font-weight: bold;
            border-right: 5px solid rgba(0, 102, 67, 1);
            padding-left: 20px;
            padding-right: 15px;
        }

        .main-content {
            /* margin-left: 200px;
            padding: 20px;
            background-color: #FDFAF5;
            min-height: 100vh;
            overflow-y: auto; */

            margin-left: 175px;
            padding: 20px;
            background-color: #FDFAF5;
            min-height: 100vh;
            min-width: 60vw;
            /* overflow-y: auto; */
        }

        .content-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1200px;
            min-height: 600px;
        }
        
        .change-password-container, .forgot-password-container {
            width: 430px;
            height: 520px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            line-height: 20px;
            background-color: white;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
        }

        .forgot-message {
            font-family: Poppins;
            color: #474541;
            /* text-align: center; */
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .change-password-container input{
           width: 50%;
            padding: 10px;
            margin: 10px 0;
            font-family: Poppins;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .change-password-container button {
            width: 50%;
            padding: 10px;
            font-family: Poppins;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid rgba(0, 102, 67, 1);
            background-color: rgba(0, 102, 67, 1);
            color: white;
            cursor: pointer;
        }
        .change-password-container h1{
           font-family: Poppins;
           font-weight: 700;
           font-size: 20px;
           line-height: 32px;
           letter-spacing: 0%;
           color: #474541;
        }
        .change-password-container h2{
           font-family: Poppins;
           font-weight: 600;
           font-size: 16px;
           line-height: 16px;
           padding-left: 20px;
           letter-spacing: 0%;
           color: #474541;
           justify-content: center;
        }
        .change-password-container p{
           font-family: Poppins;
           font-weight: 500;
           font-size: 14px;
           line-height: 0px;
           letter-spacing: 0%;
           color: #474541;
        }
        .api-key-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #E6F0EC;
            border-radius: 4px;
        }

        .api-key-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .api-key-label {
            font-weight: 600;
            color: #474541;
            margin-right: 10px;
        }

        .api-key-value {
            color: #666;
            margin-right: 10px;
        }

        .copy-icon {
            color: #007EA7;
            cursor: pointer;
        }

        .test-api-button {
            background-color: rgba(0, 102, 67, 1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            margin-top: 20px;
            width: 200px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: rgba(0, 102, 67, 1);
            font-family: 'Poppins', sans-serif;
            font-size: 24px;
            margin: 0;
        }

        .edit-button {
            background: none;
            border: none;
            color: rgba(0, 102, 67, 1);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
        }

        .edit-button:hover {
            background-color: #E6F0EC;
        }

        .edit-button i {
            font-size: 16px;
        }

        .agency-info {
            background: #FFFFFF;
            border: 1px solid #E6E6E6;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .info-row {
            margin-bottom: 16px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-row p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
            color: #474541;
        }

        .info-label {
            font-weight: 600;
            color: #00764b;
            min-width: 120px;
            display: inline-block;
            margin:0px 10px 0px 10px;
        }

          /* .info-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-family: Arial, sans-serif;
  } */

  .info-item {
    display: flex;
    justify-content: flex-start;
    font-size: 14px;
    line-height: 2.5em;
  }

  .info-label {
    width: 110px; /* Adjust width as needed */
    font-weight: bold;
  }

  .info-separator {
    width: 50px;
    text-align: center;
  }

  .info-value {
    flex: 1;
    font-weight: 600;
    font-size: 14px;
    color: #474541;
  }

        .table-actions {
            display: flex;
            gap: 8px;
            /* margin-bottom: 16px; */
        }

        .table-actions button {
            padding: 8px 16px;
            border-radius: 4px 4px 0px 0px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
        }

        .table-actions .edit-button {
            background-color: #E6F0EC;
            color: rgba(0, 102, 67, 1);
            border: 1px solid rgba(0, 102, 67, 1);
        }

        .table-actions .deactivate-button {
            /* background-color: #FFEBEB; */
            /* color: #E94D35; */
            /* border: 1px solid #E94D35; */
            background-color: #E6F0EC;
            border: 1px solid grey;
            border-bottom: none;
        }

        .table-actions .activate-button {
            /* background-color: #e8f5d3; */
            /* color: #00764b; */
            /* border: 1px solid #00764b; */
            background-color: #E6F0EC;
            border: 1px solid grey;
            border-bottom: none;

        }

        /* Active and Deactive button css */

        .activate-button,
  .deactivate-button {
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .highlight {
    background-color: #4CAF50;
    color: #006B38;
    border: 1px solid #006B38;
    font-weight: bold;
  }

  .dull {
    background-color: #f0f0f0;
    color: #888;
  }

        #agentListContainer {
            padding: 20px;
            margin-top: 20px;
        }

        #agentListContainer h2 {
            margin-bottom: 15px;
            color: #474541;
        }

        .view-deactivated {
            color: #007EA7;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .view-deactivated:hover {
            text-decoration: underline;
        }

        .clickable-username {
            color: rgba(0, 102, 67, 1);
            cursor: pointer;
            text-decoration: underline;
        }

        .deactivate-btn {
            background-color: #E94D35;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
        }

        .reactivate-btn {
            background-color: rgba(0, 102, 67, 1);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .reactivate-btn:hover {
            background-color: #00885A;
        }
        
        .agent-management-section {
            margin: 20px 0;
        }

        .button-add {
            background-color: rgba(0, 102, 67, 1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .button-add:hover {
            background-color: #00885A;
        }

        #loginHeader{
            width: 100%;
            height: 80px;
            background-color: #005a30;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loginTitle{
            font-size: 30px;
           color: #fff; 
        }

        #agentTable table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0px;
        }

        #agentTable th {
            background-color: #E6F0EC;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #474541;
            font-size: 14px;
        }

        #agentTable td {
            padding: 12px 16px;
            border-bottom: 1px solid #E6F0EC;
            font-size: 14px;
            color: #474541;
        }

        #DetailsTable table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #DetailsTable th {
            background-color: #E6F0EC;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #474541;
            font-size: 14px;
        }

        #DetailsTable td {
            padding: 12px 16px;
            border-bottom: 1px solid #E6F0EC;
            font-size: 14px;
            color: #474541;
        }

        .submenu-item {
            padding: 8px 16px;
            color: #474541;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            margin-right: 24px;
            font-size: 14px;
            cursor: pointer;
        }

        .submenu-item.active {
            color: rgba(0, 102, 67, 1);
            border-bottom: 2px solid rgba(0, 102, 67, 1);
            font-weight: 500;
        }

        .container-layout{
            margin-top: 12px;
        }

        .profile-section {
            /* position: fixed;
            top: 20px;
            right: 20px;
            display: none;
            align-items: center;
            padding: 10px;
            z-index: 1000;
            background-color: #FDFAF5; */

            width: 80%;
            height: 45px;
            position: fixed;
            top: 0px;
            right: 24px;
            display: none;
            align-items: center;
            padding: 10px;
            z-index: 1000;
            background-color: #FDFAF5;
        }

        #displayProfilePic {
            /* width: 36px;
            height: 36px;
            border: 2px solid rgba(0, 102, 67, 1);
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer; */

            width: 36px;
            height: 36px;
            position: fixed;
            top: 20px;
            right: 8em;
            border: 2px solid rgba(0, 102, 67, 1);
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer;
        }

        .page-top-spacing {
            margin-top: 60px;
        }

        .main-user {
            /* font-size: 16px;
            font-weight: bold;
            color: #474541;
            cursor: pointer;
            position: relative; */

            position: fixed;
            right: 1em;
            top: 26px;
            font-size: 16px;
            font-weight: bold;
            color: #474541;
            cursor: pointer;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            display: none;
            z-index: 1000;
            border: 1px solid #ccc;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            font-size: 14px;
            color: #474541;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #E6F0EC;
        }

        .dropdown-item i {
            color: rgba(0, 102, 67, 1);
            width: 16px;
        }

        #imageSelectionContainer {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 250px;
            z-index: 1000;
            margin-top: 5px;
            border: 1px solid #ccc;
        }

        .profile-thumbnail {
            width: 40px; 
            height: 40px;
            border: 2px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .profile-thumbnail:hover {
            transform: scale(2);
            z-index: 1001;
            border-color: rgba(0, 102, 67, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .selected-profile-photo {
            border-color: rgba(0, 102, 67, 1);
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 102, 67, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .login-container input {
            width: 50%;
            padding: 10px;
            margin: 10px 0;
            font-family: Poppins;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .login-container input:focus {
            outline: none;
            border: 1px solid #00ACEC;
        }

        .login-container input.input-error {
            border: 1px solid #E94D35 !important;
        }

        .error-message {
            color: #E94D35;
            font-family: Poppins;
            font-size: 0.9em;
            margin-top: 4px;
            display: none;
            text-align: center;
        }
        .success-message{
            color: #00764b;
            font-family: Poppins;
            font-size: 0.9em;
            margin-top: 4px;
            display: none;
            text-align: center;
        }

        .button-login {
            width: 30%;
            padding: 10px;
            font-family: Poppins;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid rgba(0, 102, 67, 1);
            background-color: rgba(0, 102, 67, 1);
            color: white;
            cursor: pointer;
        }

        .forgotpass {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        color: #007EA7;
        cursor: pointer;
        }

        .button-reg {
            width: 40%;
            padding: 10px;
            font-family: Poppins;
            font-size: 500;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid rgba(0, 102, 67, 1);
            background-color: white;
            color: rgba(0, 102, 67, 1);
            cursor: pointer;
        }

        .login-container a {
            margin-top: 10px;
            text-align: left;
            padding-right: 240px;
            font-family: Poppins;
            color: rgba(0, 122, 168, 1);
            text-decoration: none;
        }

        .login-container a:hover {
            text-decoration: underline;
        }

        .login-container p {
            font-family: Poppins;
            font-weight: 400;
            font-size: 14px;
            line-height: 20px;
            letter-spacing: 0%;
            color: #474541;
            text-align: center;
            padding: 0 20px;
        }

        hr {
            border: none;
            border-top: 1px solid #ccc;
            margin: 20px 0;
            width: 100%;
        }

        table {
            width: 90%;
            margin: 4% auto;
            border-radius: 8px;
            border: 1px solid #DFDAC9; 
            border-spacing: 0;
            font-family: 'Poppins', serif;
        }

        tbody {
            border-collapse: collapse; 
        }

        .content-section h2 {
            color: rgba(0, 102, 67, 1);
            font-family: 'Poppins', serif;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .content-para {
            font-family: 'Poppins', serif;
            font-size: 14px;
            line-height: 1.6;
            color: #474541;
            margin-bottom: 20px;
        }

        #dynamicTable th {
            padding: 1.5%;
            padding-left: 1.9%;
            text-align: left;
            font-family: 'Poppins', serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 17px;
        }

        #dynamicTable td {
            padding: 1%;
            padding-left: 4%;
            text-align: left;     
            font-family: 'Poppins', serif;
            font-size: 12px;
            font-weight: 500;
            line-height: 16px;
        }

        #dynamicTable tr {
            height: 40px;
        }

        .row_bg {
            background-color: #E6F0EC;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 102, 67, 1);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            font-family: 'Poppins', sans-serif;
            color: white;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .selected-row {
            background-color: #f0f7ff;
        }

        .deactivate-btn {
            margin: 10px 0;
            padding: 8px 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }

        .deactivate-btn:hover {
            background-color: #c82333;
        }

        .close-btn{
            margin: 10px 10px 10px 10px ;
            padding: 8px 16px;
            background-color: #005a30;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }

        .deactivate-confirm-modal {
            padding: 20px;
            text-align: center;
        }

        .deactivate-confirm-modal h3 {
            margin: 0 0 15px;
            color: #333;
        }

        .deactivate-confirm-modal p {
            margin-bottom: 20px;
            color: #666;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .modal-actions .confirm-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-actions .cancel-btn {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-actions .confirm-btn:hover {
            background-color: #c82333;
        }

        .modal-actions .cancel-btn:hover {
            background-color: #e9ecef;
        }

        .agent-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: none;
            width: 90%;
            max-width: 500px;
        }

        .agent-popup h2 {
            margin: 0 0 20px;
            color: #006B38;
            font-size: 1.5em;
        }

        .agent-popup input {
            width: 96%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .agent-popup label {
            display: block;
            margin-top: 15px;
            color: #333;
            font-weight: 500;
        }

        .verify-btn {
            background-color: #006B38;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .verify-btn:hover {
            background-color: #005a30;
        }

        .contact-details {
            margin-top: 25px;
        }

        .name-row {
            display: flex;
            gap: 35px;
            margin-bottom: 15px;
        }

        .name-row > div {
            flex: 1;
        }

        .submit-btn {
            background: #006B38;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background-color: #005a30;
        }

        .close-popup {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .modalError {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #006B38;
    color: #fff;
    padding: 40px;
    border-radius: 8px;
    z-index: 1000;
}

.modal-actions {
    margin-top: 15px;
    text-align: right;
}

.cancel-btn {
    background-color: #ccc;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
}

.modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #00764b;
    padding: 20px;
    border-radius: 8px;
    z-index: 1005;
    width: 300px;
    text-align: center;
}

.modal-actions {
    margin-top: 15px;
}

.cancel-btn {
    background-color: #ccc;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
}


/* Modal background */
.modal {
  display: none; 
  position: fixed; 
  z-index: 1000; 
  left: 0; 
  top: 0; 
  width: 100%; 
  height: 100%; 
  background-color: rgba(0,0,0,0.5);
}

/* Modal box */
.modal-content {
  background-color: #006B38;
  margin: 15% auto; 
  padding: 20px; 
  /* border-radius: 8px; */
  width: 400px;
  text-align: center;
  /* box-shadow: 0 5px 15px rgba(0,0,0,0.3); */
}

/* Close button */
.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}


.modal {
  /* display: none; 
  position: fixed; 
  z-index: 1000; 
  left: 0; 
  top: 0; 
  width: 100%; 
  height: 100%; 
  background-color: rgba(0,0,0,0.5); */

   position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #00764b;
    padding: 20px;
    border-radius: 8px;
    z-index: 1005;
    width: 300px;
    text-align: center;
    height: 10rem;
}

/* Modal box */
.modal-content {
  background-color: #fff;
  margin: 15% auto; 
  padding: 20px; 
  border-radius: 8px;
  width: 400px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* Close button */
.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}

    </style>
</head>
<body>
    <div id="loaderOverlay">
        <div class="loader">
            <svg></svg>
            <div style="position:absolute;top:40%;left:38%;transform:translate(-50%,-50%);text-align:center;">
                <!-- Replace below with your preferred text or image -->
                <!-- <span style="font-family:'Poppins',sans-serif;font-size:18px;color:#fff;">Forntier</span> -->
            <img src="/content/logo-icon.svg" alt="" style="width: 20px;height: 20px;">
             <!-- <img src="/images/logo-icon.svg" alt="F" style="width: 20px;height: 20px;"> -->
            </div>
        </div>
    </div>

    <!-- <div id="maskGroupImg">
        <img src="/images/Mask group.png" alt="" style="width: 100%; height: 2em;"/>
    </div> -->

    <div class="profile-section" id="profileSection" style="display:none;">
        <img id="displayProfilePic" alt="Current Profile Picture" onclick="profileImage(event)">
        <span class="main-user" id="displayAgentName" onclick="toggleUserDropdown(event)"></span>
        <div id="imageSelectionContainer" class="hidden"></div>
        <div class="user-dropdown" id="userDropdown">
            <div class="dropdown-item" onclick="showChangePassword()">
                <i class="fas fa-key"></i> Change Password
            </div>
            <div class="dropdown-item" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar" style="display: none;">
        <ul id="menuList">
            <!-- Menu items will be dynamically added here -->
        </ul>
    </div>

    <div class="main-content" id="mainContent" style="display: none;">
        <!-- Content for each menu item will be loaded here -->
    </div>

    <div id="loginAgainScreen" style="display:none; text-align:center; margin-bottom:200px;">
    <div style="width: 100%; height: 100%; background-color: #005a30; border: 1px solid #005a30; border-radius: 5px;">
      <h2 style="color: #fff; padding: 10px;">You have been signed out.</h2>
      <button id="loginAgainBtn" style="padding:10px 20px; font-size:16px; border-color: #fff; background-color: #005a30; color: #fff; border-radius: 5px; margin-bottom: 20px;">Login Again</button>
    </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="copyModal">API Key Copied to Clipboard!</div>
    
    <div class="modal deactivate-confirm-modal" id="deactivateModal" style="display: none;">
        <h3 style="color: #fff;">Confirm Deactivation</h3>
        <p style="color: #fff;">Are you sure you want to deactivate this user?</p>
        <div class="modal-actions">
            <button onclick="confirmDeactivation()" class="confirm-btn">Yes, Deactivate</button>
            <button onclick="closeDeactivateModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>

    <div class="modal deactivate-confirm-modal" id="reactivateModal" style="display: none;">
        <h3 style="color: #fff;">Confirm Reactivation</h3>
        <p style="color: #fff;">Are you sure you want to Reactivate this user?</p>
        <div class="modal-actions">
            <!-- <button onclick="confirmDeactivation()" class="confirm-btn">Yes, Reactivate</button>
            <button onclick="closeDeactivateModal()" class="cancel-btn">Cancel</button> -->
            <button onclick="confirmReactivation()" class="confirm-btn">Yes, Reactivate</button>
            <button onclick="closeReactivateModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>

<!-- Invalid Email Modal -->
    <div class="modal email-error-modal" id="emailErrorModal" style="display: none;">
    <h3 style="color: #fff;">Invalid Email</h3>
    <p style="color: #fff;">Please enter a valid email with @ and .com before verifying.</p>
    <div class="modal-actions">
        <button onclick="closeEmailErrorModal()" class="cancel-btn">OK</button>
    </div>
</div>

<!-- Common modal for veryfy mail -->
<div class="modal common-alert-modal" id="commonAlertModal" style="display: none;">
    <h3 style="color: #fff;" id="commonAlertTitle">Alert</h3>
    <p style="color: #fff;" id="commonAlertMessage">This is a message</p>
    <div class="modal-actions">
        <button onclick="closeCommonAlertModal()" class="cancel-btn">OK</button>
    </div>
</div>

<!-- common modal for firstName, lastname, Ph.no -->
<div class="modal common-alert-modal" id="commonAlertModal" style="display: none;">
    <h3 style="color: #fff;" id="commonAlertTitle">Alert</h3>
    <p style="color: #fff;" id="commonAlertMessage">This is a message</p>
    <div class="modal-actions">
        <button onclick="closeCommonAlertModal()" class="cancel-btn">OK</button>
    </div>
</div>

    <div class="login-container" id="loginForm">
        <div id="loginHeader"><h3 id="loginTitle">DEVELOPER PORTAL</h3></div>
        <!-- <div>User Name</div> -->
        <input type="text" id="username" placeholder="UserName" required>
        <div id="usernameError" class="error-message">Enter valid username</div>
        
        <input type="password" id="password" placeholder="Password" required>
        <div id="passwordError" class="error-message">Invalid credentials</div>
        <div id="user-passwordError" class="error-message">Username and password are required</div>
        <div id="loginfailed" class="error-message">Login failed. Please check your credentials</div>
        
        <button class="button-login" onclick="login()">Login</button>
        <!-- <button class="button-reg">Register</button> -->
         <div class="forgotpass">
        <!-- <a href="#"  onclick="forgotPassword()">Forgot Password ?</a> -->
        <span class onclick="forgotPassword()">Forgot Password ?</span>
        </div>
        <hr>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec tempor eros quis tempor varius. Mauris dignissim commodo quam in pulvinar. Fusce non mi facilisis, lacinia odio at, iaculis felis. Nam lobortis lorem sed semper posuere. Nunc viverra libero eu urna malesuada, vel condimentum sapien porta. Donec ac mi quis purus porttitor auctor nec in dui.</p>
    </div>

    <div class="change-password-container" id="forgotPasswordForm" style="display: none;">
        <h1>Forgot Password</h1>
        <p class="forgot-message">An email will be sent to the username's email address.</p>
        <input type="text" id="usernamef" placeholder="Username" required>
        <button class="button-login" onclick="submitForgotPassword()">Submit</button>
        <!-- <div id="emptyUsername" class="error-message">Please enter username</div>
        <div id="usernameNotFound" class="error-message">Username not found</div> -->
        <div id="successMessage" class="success-message">Success, Password reset link sent to your email</div>
    </div>


<div id="errorModal" class="modalError">
  <!-- <div class="modal-content"> -->
    <span class="close" onclick="closeErrorModal()">&times;</span>
    <h2>Error</h2>
    <p id="errorMessage"></p>
  <!-- </div> -->
</div>

    <div class="change-password-container" id="enterOTPForm" style="display: none;">
        <h1>Forgot Password - Change Password</h1>
        <div>
            <input type="password" id="oldPasswordf" placeholder="Enter Temporary Password" class="password-input">
            <input type="password" id="newPasswordf" placeholder="Enter New Password" class="password-input">
            <input type="password" id="confirmNewPasswordf" placeholder="Confirm New Password" class="password-input">
            
            <div>
                <h2>Password Policy:</h2>
                <ul>
                    <li><p>Between 8-16 characters</p></li>
                    <li><p>Include at least one upper case letter</p></li>
                    <li><p>Include at least one lower case letter</p></li>
                    <li><p>Include at least one numeric digit</p></li>
                    <li><p>Include at least one non-alphanumeric</p></li>
                    <li><p>Cannot contain a period(.) comma(,) or tilde(~)</p></li>
                </ul>
            </div>

            <button onclick="forgotchangePassword()" class="button-login">Change Password</button>
            <div id="cpasswordErrorEmpty" class="error-message" style="display: none;"></div>
            <div id="cpasswordError" class="error-message" style="display: none;">Passwords do not match, Re-entered password</div>
            <div id="successPasswordChange" class="success-message" style="display: none;">Password has been changed successfully</div>
        </div>
    </div>

    <div id="errorModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeErrorModal()">&times;</span>
    <h2>Error</h2>
    <p id="errorMessage"></p>
  </div>
</div>

    <div class="forgot-password-container" id="forcePasswordForm" style="display: none;">
        <h1>Force Password Change</h1>
        <p class="forgot-message">For security reasons, you need to change your password. A temporary password has been sent to your email.</p>
        <input type="password" id="tempPasswordf" placeholder="Enter Temporary Password" class="password-input">
        <input type="password" id="newPasswordf" placeholder="Enter New Password" class="password-input">
        <input type="password" id="confirmNewPasswordf" placeholder="Confirm New Password" class="password-input">
        
        <div style="margin: 20px 0;">
            <h3 style="color: #474541; font-size: 16px; margin-bottom: 15px;">Password Policy:</h3>
            <ul style="list-style-type: none; padding-left: 0; color: #474541; font-size: 14px; line-height: 1.8;">
                <li>• Between 8-16 characters</li>
                <li>• Include at least one upper case letter</li>
                <li>• Include at least one lower case letter</li>
                <li>• Include at least one numeric digit</li>
                <li>• Include at least one non-alphanumeric</li>
                <li>• Cannot contain a period(.) comma(,) or tilde(~)</li>
            </ul>
        </div>

        <button onclick="handleForcePasswordChange()" class="button-login">Change Password</button>
        <div id="forcePasswordError" class="error-message" style="display: none;"></div>
    </div>

    <span id="displayAnonToken" style="display: none;"></span>
    <span id="forceChangeUsername" style="display: none;"></span>

    <div class="agent-popup" id="agentPopup" style="display: none;">
        <span class="close-popup" onclick="closeAgentPopup()">&times;</span>
        <h2>Agent Details</h2>
        <!-- <div>
            <label>Username/Email</label>
            <input type="email" id="agentName" placeholder="Enter email address" required>
            <button onclick="verifyEmail()" class="verify-btn" id="verifyEmailLink">Verify Email</button>
            <span class="email-verified hidden" id="emailVerifiedText">Email Verified</span>
        </div> -->
        <div>
    <label>Email<span style="color: #c82333;">*</span></label>
    <input type="email" id="agentName" placeholder="Enter email address" required>
    <button onclick="verifyEmail()" class="verify-btn" id="verifyEmailLink">Verify Email</button>
    <span class="email-verified hidden" id="emailVerifiedText">Email Verified</span>
    <span id="emailError" style="color: red; display: none;">Enter valid email with @ and .com</span>
</div>

        <div id="otpModal" class="modal-overlay hidden">
            <div class="modal-box">
                <h3>Enter OTP</h3>
                <p>Please enter the OTP sent to your email</p>
                <input type="text" id="otpInput" placeholder="Enter OTP" class="form-control">
                <div class="modal-actions">
                    <button onclick="verifyOtp()" class="confirm-btn">Verify OTP</button>
                    <button onclick="closeOtpModal()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="contact-details">
            <h3 style="color: #006B38;">Contact Details</h3>
            <div class="name-row">
                <div>
                    <label>First Name<span style="color: #c82333;">*</span></label>
                    <input type="text" id="agentNamef" placeholder="Enter First Name" required>
                </div>
                <div>
                    <label>Last Name<span style="color: #c82333;">*</span></label>
                    <input type="text" id="agentNamel" placeholder="Enter Last Name" required>
                </div>
            </div>
            <!-- <div>
                <label>Phone Number<span style="color: #c82333;">*</span></label>
                <input type="tel" id="phoneNum" placeholder="Enter Phone Number" required>
            </div> -->
            <div>
   <div>
    <label>Phone Number<span style="color: #c82333;">*</span></label>
    <input type="tel" id="phoneNum" placeholder="Enter Phone Number" required
           maxlength="10" inputmode="numeric"
           oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);">
</div>
            <p id="agentSuccessMessage" style="color: green; display: none; margin-top: 10px;">Agent added successfully!</p>
            <button class="submit-btn" onclick="submitAgentDetails()">Submit</button>
        </div>
            </div>
        </div>
    </div>

    <!-- <div class="login-container" id="loginAgain">
        <h3>Login Again</h3>
        <button class="button-reg">Register</button>
        <hr>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec tempor eros quis tempor varius. Mauris dignissim commodo quam in pulvinar. Fusce non mi facilisis, lacinia odio at, iaculis felis. Nam lobortis lorem sed semper posuere. Nunc viverra libero eu urna malesuada, vel condimentum sapien porta. Donec ac mi quis purus porttitor auctor nec in dui.</p>
    </div> -->

    <script>
        //const API_BASE = 'https://localhost:7151/api/v1';
        //const API_BASE = 'https://tstndc-supportapi.jollyground-29886332.centralus.azurecontainerapps.io/api/v1';
        //const API_BASE = 'https://mtier-qa.flyfrontier.com/support/api/v1';
        const API_BASE = 'https://f9pcitstcusmtierapim.azure-api.net/support/api/v1'
        // const API_BASE = 'https://mtier-qa.flyfrontier.com/b2bapi/api/v1';
        const OCP_Sub_Key = '9513b8f17e0440c28b22ceda36c1184a';
        const PLACEHOLDER_IMAGE_URL = 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=';
        let imagesLoaded = false;
        let currentProfilePhotoId = null;

        // Helper function to get data from storage (either sessionStorage or parent window)
        async function getStorageData(key) {
            try {
                if (window.top !== window.self) {
                    // We're in an iframe, request data from parent
                    return new Promise((resolve) => {
                        const messageHandler = function(event) {
                            if (event.data && event.data.type === 'TOKEN_RESPONSE') {
                                window.removeEventListener('message', messageHandler);
                                resolve(event.data.token);
                            }
                        };
                        
                        window.addEventListener('message', messageHandler);
                        
                        window.parent.postMessage({
                            type: 'GET_TOKEN'
                        }, '*');
                        
                        // Timeout after 5 seconds
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            resolve(null);
                        }, 5000);
                    });
                } else {
                    // We're in the main window
                    return sessionStorage.getItem(key);
                }
            } catch (error) {
                console.warn('Storage access error:', error);
                return null;
            }
        }

        // Helper function to set storage data
        async function setStorageData(data) {
            console.log('Setting storage data-1:', data);
            try {
                if (window.top !== window.self) {
                    // We're in an iframe
                    window.parent.postMessage({
                        type: 'STORE_DATA',
                        data: data
                    }, '*');
                } else {
                    // Direct storage
                    Object.entries(data).forEach(([key, value]) => {
                        sessionStorage.setItem(key, value);
                    });
                }
            } catch (error) {
                console.warn('Storage access error:', error);
            }
        }

        // Helper functions for storage operations
        async function getStorageData(key) {
            console.log('Getting storage data for key:', key);
            try {
                if (window.top !== window.self) {
                    // We're in an iframe
                    return new Promise((resolve) => {
                        const handler = (event) => {
                            if (event.data.type === 'DATA_RESPONSE') {
                                window.removeEventListener('message', handler);
                                resolve(event.data.data[key]);
                            }
                        };
                        window.addEventListener('message', handler);
                        window.parent.postMessage({
                            type: 'GET_DATA',
                            keys: [key]
                        }, '*');
                    });
                } else {
                    return sessionStorage.getItem(key);
                }
            } catch (error) {
                console.warn('Storage access error:', error);
                return null;
            }
        }

        async function setStorageData(data) {
            console.log('Setting storage data-2:', data);
            try {
                if (window.top !== window.self) {
                    // We're in an iframe
                    window.parent.postMessage({
                        type: 'STORE_DATA',
                        data: data
                    }, '*');
                } else {
                    Object.entries(data).forEach(([key, value]) => {
                        sessionStorage.setItem(key, value);
                    });
                }
            } catch (error) {
                console.warn('Storage access error:', error);
            }
        }

        async function apiRequest(endpoint, { method = 'GET', headers = {}, body = null, token = null } = {}) {
            // If no token provided, try to get it from storage
            if (!token) {
                token = window.currentAuthToken || await getStorageData('authToken');
            }

            const defaultHeaders = {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'x-api-version': '1.0',
                'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            };
            const mergedHeaders = { ...defaultHeaders, ...headers };
            const options = {
                method,
                headers: mergedHeaders
            };
            if (body) options.body = JSON.stringify(body);

            console.log('Making API request to:', endpoint);
            console.log('Request headers:', mergedHeaders);

            const response = await fetch(`${API_BASE}${endpoint}`, options);
            console.log('Response status:', response.status);

            let data;
            try {
                data = await response.json();
                console.log('Response data:', data);
            } catch {
                console.log('No JSON response');
                data = {};
            }
            return { response, data };
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            document.getElementById('username').classList.remove('input-error');
            document.getElementById('password').classList.remove('input-error');
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('user-passwordError').style.display = 'none';
            document.getElementById('loginfailed').style.display = 'none';
            

            if (!username && !password) {
                document.getElementById('username').classList.add('input-error');
                document.getElementById('password').classList.add('input-error');
                document.getElementById('user-passwordError').style.display = 'block';
                return;
            } else if (!username ) {
                document.getElementById('username').classList.add('input-error');
                // document.getElementById('password').classList.add('input-error');
                document.getElementById('passwordError').style.display = 'block';
                // document.getElementById('user-passwordError').style.display = 'block';
                return;
            } else if (!password) {
                // document.getElementById('username').classList.add('input-error');
                document.getElementById('password').classList.add('input-error');
                document.getElementById('passwordError').style.display = 'block';
                // document.getElementById('user-passwordError').style.display = 'block';
                return;
            }  

            document.getElementById('loaderOverlay').style.display = 'flex';
            console.log('Attempting login for username:', username);

            try {
                console.log('Sending login request...');
                const response =await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'text/plain',
                        'Content-Type': 'application/json',
                        'x-api-version': '1.0',
                        //'Access-Control-Allow-Origin': 'https://gray-forest-086582d10.3.azurestaticapps.net',
                        //'Access-Control-Allow-Methods': ['GET', 'POST', 'OPTIONS'],
                        //'Access-Control-Allow-Credentials': true,
                        'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                    },
                    body: JSON.stringify({username, password})
                    // username, password
                });
                
                console.log('Login response status:', response.status);
                
                const result = await response.json();
                console.log('Login response data:', result);

                if (!response.ok) {
                    console.log('Login failed - Response not OK:', response.status);
                    document.getElementById('username').classList.add('input-error');
                    document.getElementById('password').classList.add('input-error');
                    document.getElementById('loginfailed').style.display = 'block';
                    return;
                }
                
                if (!result) {
                    console.log('Login failed - No response data');
                     document.getElementById('username').classList.add('input-error');
                    document.getElementById('password').classList.add('input-error');
                    document.getElementById('loginfailed').style.display = 'block';
                    return;
                }
                
                console.log('Login response is OK, checking for force password change...');

                // Check for force password change
                if (!result.status && result.message && result.message.length > 0 && 
                    result.message[0].message === "Force password change") {
                    console.log('Force password change required for user:', username);
                    // Store username for force password change
                    document.getElementById('forceChangeUsername').textContent = username;
                    
                    // Call force password change endpoint
                    try {
                        const { response: forceResponse } = await apiRequest(
                            `/auth/forcepasswordchange?username=${encodeURIComponent(username)}`, 
                            { method: 'GET' }
                        );
                        
                        if (forceResponse.ok) {
                            document.getElementById('loginForm').style.display = 'none';
                            document.getElementById('forcePasswordForm').style.display = 'block';
                        } else {
                            throw new Error('Failed to initiate force password change');
                        }
                    } catch (error) {
                        console.error('Force password change error:', error);
                        // document.getElementById('passwordError').textContent = 'Failed to process force password change';
                        // document.getElementById('passwordError').style.display = 'block';
                         document.getElementById('username').classList.add('input-error');
                    document.getElementById('password').classList.add('input-error');
                    document.getElementById('loginfailed').style.display = 'block';
                    }
                    return;
                }

                // Normal login success
                if (result.status && result.data && result.data.token && result.data.profilePhoto) {
                    console.log('Login successful - storing user data');
                    
                    // Store token in a global variable for immediate use
                    window.currentAuthToken = result.data.token;
                    // Store apiKey in a global variable for immediate use
                    window.currentApiKey = result.data.key;
                    // Store userName in a global variable for immediate use
                    window.currentUserName = username;
                    //strore profilePhotoId in a global variable for immediate use
                    window.currentProfilePhotoId = result.data.profilePhotoId;
                    
                    try {
                        if (window.top !== window.self) {
                            console.log('Sending login data to parent window');
                            window.parent.postMessage({
                                type: 'LOGIN_SUCCESS',
                                data: {
                                    token: result.data.token,
                                    profilePhoto: result.data.profilePhoto,
                                    username: username,
                                    apiKey: result.data.key
                                }
                            }, '*');
                        } 
                        // else {
                        //     sessionStorage.setItem('authToken', result.data.token);
                        //     sessionStorage.setItem('profilePhoto', result.data.profilePhoto);
                        //     sessionStorage.setItem('username', username);
                        //     sessionStorage.setItem('apiKey', result.data.key);
                        // }
                    } catch (storageError) {
                        console.warn('Storage error:', storageError);
                    }

                    try {
                        // Update display elements
                        document.getElementById('displayProfilePic').src = result.data.profilePhoto;
                        document.getElementById('displayAgentName').textContent = username;
                        // Show profile section and update profile info
                        var profileSection = document.getElementById('profileSection');
                        if (profileSection) profileSection.style.display = 'flex';
                        document.getElementById('loginForm').style.display = 'none';
                    } catch (displayError) {
                        console.warn('Display update error:', displayError);
                    }
                        
                        // Show sidebar and main content
                        document.getElementById('sidebar').style.display = 'block';
                        document.getElementById('mainContent').style.display = 'block';
                        
                        // Load role-based menu immediately after login
                        console.log('Initializing menu load...');
                        await loadRoleBasedMenu();
                    document.getElementById('displayAgentName').textContent = username;
                    document.getElementById('displayProfilePic').src = result.data.profilePhoto;
                    
                    // Show sidebar and main content
                    document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    // Load role-based menu and initial data
                    loadRoleBasedMenu();
                    loadSubAgents(); // Load initial agent list
                } else {
                    // document.getElementById('password').classList.add('input-error');
                    // document.getElementById('passwordError').style.display = 'block';
                     document.getElementById('username').classList.add('input-error');
                    document.getElementById('password').classList.add('input-error');
                    document.getElementById('loginfailed').style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                // document.getElementById('password').classList.add('input-error');
                // document.getElementById('passwordError').style.display = 'block';
                 document.getElementById('username').classList.add('input-error');
                    document.getElementById('password').classList.add('input-error');
                    document.getElementById('loginfailed').style.display = 'block';
            } finally {
                document.getElementById('loaderOverlay').style.display = 'none';
            }
        }

        // Close image selection container when clicking outside
        document.addEventListener('click', function(event) {
            const imageSelectionContainer = document.getElementById('imageSelectionContainer');
            const profilePic = document.getElementById('displayProfilePic');
            
            if (!imageSelectionContainer.contains(event.target) && event.target !== profilePic) {
                imageSelectionContainer.classList.add('hidden');
            }
        });

        async function profileImage(event) {
            event.stopPropagation(); // Prevent event from bubbling up
            const imageSelectionContainer = document.getElementById('imageSelectionContainer');
            const imageLoadingSpinner = document.getElementById('loaderOverlay');

            // Toggle visibility of the container
            if (imageSelectionContainer.classList.contains('hidden')) {
                imageSelectionContainer.classList.remove('hidden');
            } else {
                imageSelectionContainer.classList.add('hidden');
                return;
            }

            // Only load images if they haven't been loaded yet
            if (!imagesLoaded) {
                imageLoadingSpinner.style.display = 'flex';
                imageSelectionContainer.innerHTML = '';

                const apiUrl = `${API_BASE}/profilephoto/getallphoto`;

                try {
                    const token = window.currentAuthToken || await getStorageData('authToken');
                    const { response } = await apiRequest('/profilephoto/getallphoto', {
                        method: 'GET',
                        token: token
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorText}`);
                    }

                    const result = await response.json();

                    if (result && result.status && result.data && result.data.list && result.data.list.length > 0) {
                        result.data.list.forEach(photoData => {
                            const img = document.createElement('img');
                            img.src = photoData.photo;
                            img.alt = 'Profile Image';
                            img.classList.add('profile-thumbnail');
                            img.dataset.photoid = photoData.id;

                            img.addEventListener('click', () => {
                                changeProfilePhoto(photoData.id);
                            });

                            img.onerror = () => {
                                img.src = PLACEHOLDER_IMAGE_URL + 'Error';
                                console.error(`Failed to load image: ${photoData.photo}`);
                            };

                            imageSelectionContainer.appendChild(img);
                        });
                        imagesLoaded = true;

                        if (currentProfilePhotoId) {
                            const selectedImg = document.querySelector(`.profile-thumbnail[data-photoid="${currentProfilePhotoId}"]`);
                            if (selectedImg) {
                                selectedImg.classList.add('selected-profile-photo');
                            }
                        }
                    } else {
                        imageSelectionContainer.innerHTML = `<p style="color: #666;">No other images available.</p>`;
                    }
                } catch (error) {
                    console.error('Error fetching profile images:', error);
                    imageSelectionContainer.innerHTML = `<p style="color: #E94D35;">Failed to load images. Please try again.</p>`;
                    imagesLoaded = false;
                } finally {
                    imageLoadingSpinner.style.display = 'none';
                }
            }
        }

        async function changeProfilePhoto(photoId) {
            const changePhotoUrl = `${API_BASE}/user/changeprofilephoto/${photoId}`;
            // const token = window.currentAuthToken || sessionStorage.getItem('authToken');
            const loaderOverlay = document.getElementById('loaderOverlay');
            const imageSelectionContainer = document.getElementById('imageSelectionContainer');

            // Remove previous selection highlight
            document.querySelectorAll('.profile-thumbnail').forEach(img => {
                img.classList.remove('selected-profile-photo');
            });

            // Add highlight to selected image
            const selectedImage = document.querySelector(`.profile-thumbnail[data-photoid="${photoId}"]`);
            if (selectedImage) {
                selectedImage.classList.add('selected-profile-photo');
            }

            loaderOverlay.style.display = 'flex';

            try {
                 const token = window.currentAuthToken 
                //  || sessionStorage.getItem('authToken');
                const response = await fetch(changePhotoUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-api-version': '1.0',
                        'Authorization': `Bearer ${token}`,
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorText}`);
                }

                const result = await response.json();

                if (result && result.status) {
                    currentProfilePhotoId = photoId;
                    const clickedImageElement = document.querySelector(`.profile-thumbnail[data-photoid="${photoId}"]`);
                    if (clickedImageElement) {
                        document.getElementById('displayProfilePic').src = clickedImageElement.src;
                    }
                    
                    document.getElementById('imageSelectionContainer').classList.add('hidden');
                } else {
                    throw new Error(result.message || 'Unknown error during photo update');
                }
            } catch (error) {
                console.error('Error changing profile photo:', error);
            } finally {
                loaderOverlay.style.display = 'none';
            }
        }

        async function loadRoleBasedMenu() {

            //  const token = sessionStorage.getItem('authToken');
            const loaderOverlay = document.getElementById('loaderOverlay');
            loaderOverlay.style.display = 'flex';
            
            try {
                // Use the token from global variable if available (right after login)
                // or try to get it from storage
                const token = window.currentAuthToken || await getStorageData('authToken');
                console.log('Loading menu with token:', token ? 'Token found' : 'No token found');
                
                if (!token) {
                    throw new Error('No authentication token available');
                }
                
                const response = await fetch(`${API_BASE}/menu/getmenusbyrole`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-api-version': '1.0',
                        'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                        'Authorization': `Bearer ${token}`,
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch menus');
                }

                const result = await response.json();
                
                if (result.status && result.data) {
                    const menuList = document.getElementById('menuList');
                    menuList.innerHTML = ''; // Clear existing menu items
                    
                    console.log('Menu items received:', result.data);
                    result.data.forEach((menuItem, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<i class="${menuItem.icon}"></i> ${menuItem.name}`;
                        li.dataset.endpoint = menuItem.endpoint;
                        li.dataset.canAddSubAgent = menuItem.canAddSubAgent;
                        if (index === 0) {
                            li.classList.add('active-menu-item');
                            loadMenuContent(menuItem.endpoint, menuItem.name, menuItem.canAddSubAgent);
                        }
                        
                        li.addEventListener('click', function() {
                            // Remove active class from all menu items
                            document.querySelectorAll('.sidebar li').forEach(item => {
                                item.classList.remove('active-menu-item');
                            });
                            
                            // Add active class to clicked menu item
                            this.classList.add('active-menu-item');
                            
                            // Load content for this menu item
                            loadMenuContent(this.dataset.endpoint, menuItem.name, menuItem.canAddSubAgent);
                        });
                        
                        menuList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Error loading menu:', error);
            } finally {
                loaderOverlay.style.display = 'none';
            }
        }

        async function loadMenuContent(endpoint, menuName, canAddSubAgent) {
            console.log(endpoint)
             console.log(menuName)
            const mainContent = document.getElementById('mainContent');
            const token = window.currentAuthToken || await getStorageData('authToken');
            
            console.log('Loading content for menu:', menuName);
            if (!token) {
                console.error('No authentication token available for menu content');
                return;
            }

    // Empty string for submenu since we're using side menu
    const submenuHTML = '';    // Special case for APIs Certified page
            if (menuName === "Support Tickets" || menuName === "Customer Support Tickets") {
                // const apiKey = sessionStorage.getItem('apiKey');
                const apiKey = window.currentApiKey || await getStorageData('apiKey');
                // const apiKey = await getStorageData('apiKey');
                const viewTicketUrl = `https://tstndc-supportui.jollyground-29886332.centralus.azurecontainerapps.io/viewTicket?apiKey=${apiKey}`;
                mainContent.innerHTML = `
                    <div class="content-container">
                        <div class="content-section">
                            <h2 style="color: rgba(0, 102, 67, 1); font-family: Poppins; margin-bottom: 20px;">
                                ${menuName}
                            </h2>
                            <p class="content-para">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec tempor eros quis tempor varius. Mauris 
                                dignissim commodo quam in pulvinar. Fusce non mi facilisis, lacinia odio at, iaculis felis. Nam lobortis 
                                lorem sed semper posuere. Nunc viverra libero eu urna malesuada, vel condimentum sapien porta. 
                                Donec ac mi quis purus porttitor auctor nec in dui.
                            </p>
                            <a href="https://tstndc-supportui.jollyground-29886332.centralus.azurecontainerapps.io/viewTicket?apiKey=${apiKey}" target="_blank">
                                <button class="button-login" style="width: 200px; margin-top: 20px;'">
                                View All Tickets
                            </button>
                                </a>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (menuName === "APIs Certified " ) {
                mainContent.innerHTML = `
                    <div class="content-container">
                        <div id="org-apicertified-content" class="content-section">
                            <h2>${menuName}</h2>
                            <p class="content-para">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec tempor eros quis tempor varius. Mauris dignissim commodo quam in pulvinar. Fusce non mi facilisis, lacinia odio at, iaculis felis. Nam lobortis lorem sed semper posuere. Nunc viverra libero eu urna malesuada, vel condimentum sapien porta. Donec ac mi quis purus porttitor auctor nec in dui.</p>
                            <table class="content-para" id="dynamicTable">
                                <thead>
                                    <tr>
                                        <th>Version</th>
                                        <th style="padding-left:6%;">Message</th>
                                        <th>Effective Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                `;
                loadApiCertifiedTable();
                return;
            }
                

            if (endpoint.includes('{username}')) {
                // endpoint = endpoint.replace('{username}', sessionStorage.getItem('username'));
                endpoint = endpoint.replace('{username}', window.currentUserName);
                console.log(endpoint, "ENDPOINT")
            }

            if (endpoint !== "") {
                try {
                const response = await fetch(`${API_BASE}/${endpoint.startsWith('/') ? endpoint.substring(1) : endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-api-version': '1.0',
                        'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                        'Authorization': `Bearer ${token}`,
                    }
                });

                console.log(response, "CHECK_POINT")

                if (!response.ok) {
                    // throw new Error('Failed to load content');
                }

                const result = await response.json();

                console.log('Menu content response for', menuName, ':', result);
                if (menuName === "Account" && result.data && result.data.agencyResponse) {
                    const agency = result.data.agencyResponse;
                    const address = [agency.streetAddress, agency.city, agency.state, agency.country, agency.zipCode]
                        .filter(part => part && part !== '.')
                        .join(', ');
                    
                    // const userName = sessionStorage.getItem('username');
                    const userName = window.currentUserName 
                    // || await getStorageData('username');
                    
                    mainContent.innerHTML = `
                        ${submenuHTML}
                        <div class="content-container page-top-spacing">
                            <div class="content-section">
                                <div class="section-header">
                                    <h2>Agency Details</h2>
                                </div>
                                <div class="agency-info">
  <div class="info-item">
    <div class="info-label">Username</div>
    <div class="info-separator">:</div>
    <div class="info-value">${userName || '-'}</div>
  </div>
  <div class="info-item">
    <div class="info-label">IATA Code</div>
    <div class="info-separator">:</div>
    <div class="info-value">${agency.organizationCode || '-'}</div>
  </div>
    <div class="info-item">
    <div class="info-label">Tax ID</div>
    <div class="info-separator">:</div>
    <div class="info-value">${agency.taxId || '-'}</div>
  </div>
    <div class="info-item">
    <div class="info-label">Agency Name</div>
    <div class="info-separator">:</div>
    <div class="info-value">${agency.organizationName || '-'}</div>
  </div>
    <div class="info-item">
    <div class="info-label">Email</div>
    <div class="info-separator">:</div>
    <div class="info-value">${agency.organizationEmailId || '-'}</div>
  </div>
    <div class="info-item">
    <div class="info-label">Address</div>
    <div class="info-separator">:</div>
    <div class="info-value">${address || '-'}</div>
  </div>
                                </div>
                                <div class="section-header">
                                    <h2>Agent Details</h2>
                                    ${canAddSubAgent ? '<button class="button-add" onclick="addAgent()">Add an Agent</button>' : ''}
                                </div>
                                <div id="agentTable">
                                   
                                    <div class="table-actions">
  <button id="activeBtn" class="activate-button highlight" onclick="handleActiveClick()">Active List</button>
  <button id="deactiveBtn" class="deactivate-button dull" onclick="handleDeactiveClick()">De-active List</button>
</div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Username</th>
                                                <th>Name</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    loadSubAgents();
                    return;
                }
                
                if (result.status) {
                    if (menuName === "API Keys" && result.data && result.data.keyResponse) {
                        mainContent.innerHTML = `
                            ${submenuHTML}
                            <div class="content-container page-top-spacing">
                                <h2>API Keys</h2>
                                <p class="content-para">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec tempor eros quis tempor varius. Mauris dignissim commodo quam in pulvinar. Fusce non mi facilisis, lacinia odio at, iaculis felis. Nam lobortis lorem sed semper posuere. Nunc viverra libero eu urna malesuada, vel condimentum sapien porta. Donec ac mi quis purus porttitor auctor nec in dui.</p>
                                <div id="apiKeysContent">
                                    ${result.data.keyResponse.map(key => `
                                        <div class="api-key-container">
                                            <div class="api-key-row">
                                                <span class="api-key-label">${key.env === 'prod' ? 'Prod' : 'Test'} API Key :</span>
                                                <span class="api-key-value">${key.apiKey}</span>
                                                <i class="fas fa-copy copy-icon" onclick="copyApiKey('${key.apiKey}')"></i>
                                            </div>
                                        </div>
                                    `).join('')}
                                    <a href="/demopage" target="_blank">
                               <button class="test-api-button" >Test API</button>
                                </a>
                                    
                                </div>
                            </div>
                        `;
                    } else {
                        // mainContent.innerHTML = `
                        //     ${submenuHTML}
                        //     <div class="content-container page-top_spacing">
                        //         <h2 style="color: rgba(0, 102, 67, 1); font-family: Poppins; margin-bottom: 20px;">
                        //             ${menuName}
                        //         </h2>
                        //         <div style="font-family: Poppins;">
                        //             ${JSON.stringify(result.data, null, 2)}
                        //         </div>
                        //     </div>
                        // `;
                        const f9users = result.data;
                        if (menuName === "Account") {
                         mainContent.innerHTML = `
                        ${submenuHTML}
                        <div class="content-container page-top-spacing">
                            <div class="content-section">
                                <div class="section-header">
                                    <h2>${menuName}</h2>
                                </div>
                                <div class="agency-info">
    <div class="info-item">
    <div class="info-label">Username</div>
    <div class="info-separator">:</div>
    <div class="info-value">${f9users.userName  || '-'}</div>
  </div>
   <div class="info-item">
    <div class="info-label">Name</div>
    <div class="info-separator">:</div>
    <div class="info-value">${f9users.name || '-'}</div>
  </div>
   <div class="info-item">
    <div class="info-label">Email</div>
    <div class="info-separator">:</div>
    <div class="info-value">${f9users.emailId  || '-'}</div>
  </div>
                                </div>
                                <div id="agentTable">
                                    <div class="table-actions">
                                        <div class="section-header">
                                            <h2>Agent List</h2>
                                            </div>
                                    </div>
                                    <div class="table-actions">
  <button id="activeBtn" class="activate-button highlight" onclick="handleActiveClick()">Active List</button>
  <button id="deactiveBtn" class="deactivate-button dull" onclick="handleDeactiveClick()">De-active List</button>
</div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Username</th>
                                                <th>Name</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    loadSubAgents();
                    return;
                } 
                if (menuName==="Organization Details"){
                        mainContent.innerHTML = `
                            ${submenuHTML}
                            <div class="content-container page-top_spacing">
                                <h2 style="color: rgba(0, 102, 67, 1); font-family: Poppins; margin-bottom: 20px;">
                                    ${menuName}
                                </h2>
                                <div id="DetailsTable" style="font-family: Poppins;">
                                    <table style="width:100%; border-collapse:collapse; margin-bottom:32px;">
                                         <thead>
                                            <tr>
                                                <th>S.No</th>
                                                <th>Organization Name</th>
                                                <th>Organization Code</th>
                                                <th>organization Email Id</th>
                                                <th>Tax Id</th>
                                                <th>Address</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(result.data).map(([key, value], idx) => `
                                                <tr>
                                                    <th style="text-align:left; padding:8px; width:20px;">${idx + 1}</th>
                                                    <td style="padding:8px;">${value.organizationName !== null && value.organizationName !== undefined && value.organizationName !== '' ? value.organizationName : '-'}</td>
                                                    <td style="padding:8px;">${value.organizationCode !== null && value.organizationCode !== undefined && value.organizationCode !== '' ? value.organizationCode : '-'}</td>
                                                    <td style="padding:8px;">${value.organizationEmailId !== null && value.organizationEmailId !== undefined && value.organizationEmailId !== '' ? value.organizationEmailId : '-'}</td>
                                                    <td style="padding:8px;">${value.taxId !== null && value.taxId !== undefined && value.taxId !== '' ? value.taxId : '-'}</td>
                                                    <td style="padding:8px;">${[value.streetAddress, value.city, value.state, value.country, value.zipCode]
                        .filter(part => part && part !== '.')
                        .join(', ')}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        }
                    }
                }
            } catch (error) {
                // console.error('Error loading content:', error);
                mainContent.innerHTML = `
                    ${submenuHTML}
                    <div class="content-container page-top-spacing">
                        <p style="color: #E94D35;">Error loading content. Please try again.</p>
                    </div>
                `;
            }
            }
        }

    //     function loginAgain() {
    //             mainContent.innerHTML = `
    //                 <div class="login-container" id="loginAgain">
    //     <h3>Login Again</h3>
    //     <button class="button-reg">Register</button>
    //     <hr>
    //     <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec tempor eros quis tempor varius. Mauris dignissim commodo quam in pulvinar. Fusce non mi facilisis, lacinia odio at, iaculis felis. Nam lobortis lorem sed semper posuere. Nunc viverra libero eu urna malesuada, vel condimentum sapien porta. Donec ac mi quis purus porttitor auctor nec in dui.</p>
    // </div>
    //             `;
    //             return;
    //     }
        
        function loadApiCertifiedTable() {
            const columnContent = {
                columnOne: 'Version',
                columnTwo: 'Message',
                columnThree: 'Effective Date',
            };
    
            const rowContent = {
                rowOne: {
                    col1: '18.1',
                    col2: 'AirshoppingRQ',
                    col3: '2022-01-13'
                },
                rowTwo: {
                    col1: '18.1',
                    col2: 'AirShoppingRS',
                    col3: '2022-01-13'
                },
                rowThree: {
                    col1: '18.1',
                    col2: 'OfferPriceRQ',
                    col3: '2022-01-13'
                },
                rowFour: {
                    col1: '18.1',
                    col2: 'OfferPriceRS',
                    col3: '2022-01-13'
                },
                rowFive: {
                    col1: '18.1',
                    col2: 'OrderCancelRQ',
                    col3: '2022-01-13'
                },
                rowSix: {
                    col1: '18.1',
                    col2: 'OrderCancelRS',
                    col3: '2022-01-13'
                },
                rowSeven: {
                    col1: '18.1',
                    col2: 'OrderChangeNotif',
                    col3: '2022-01-13'
                },
                rowEight: {
                    col1: '18.1',
                    col2: 'OrderChangeRQ',
                    col3: '2022-01-13'
                },
            };
    
            const table = document.getElementById('dynamicTable');
            if (!table) {
                console.error("Error: Table with ID 'dynamicTable' not found.");
                return;
            }
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                console.error("Error: tbody not found inside 'dynamicTable'. Ensure your table has a <tbody> tag.");
                return;
            }
            tbody.innerHTML = '';
            let rowCount = 0;
            Object.values(rowContent).forEach((rowData) => {
                const row = document.createElement('tr');
                Object.values(rowData).forEach((cellContent) => {
                    const cell = document.createElement('td');
                    cell.textContent = cellContent;
                    row.appendChild(cell);
                });
                if (rowCount % 2 === 0) {
                    row.classList.add('row_bg');
                }
                tbody.appendChild(row);
                rowCount++;
            });
        }

        async function copyApiKey(apiKey) {
            try {
                await navigator.clipboard.writeText(apiKey);
                const modal = document.getElementById('copyModal');
                const overlay = document.getElementById('modalOverlay');
                
                modal.style.display = 'block';
                overlay.style.display = 'block';
                
                // Hide the modal after 2 seconds
                setTimeout(() => {
                    modal.style.display = 'none';
                    overlay.style.display = 'none';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy API key:', err);
            }
        }

        function toggleUserDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const username = document.getElementById('displayAgentName');
            
            if (!dropdown.contains(event.target) && event.target !== username) {
                dropdown.classList.remove('show');
            }
        });

        async function handleLogout() {
            document.getElementById('loaderOverlay').style.display = 'flex';
            // Hide profile section on logout
            var profileSection = document.getElementById('profileSection');
            if (profileSection) profileSection.style.display = 'none';
            try {
                const token = window.currentAuthToken || await getStorageData('authToken');
                const response = await fetch(`${API_BASE}/auth/signout`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-api-version': '1.0',
                        'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                        'Authorization': `Bearer ${token}`,
                    }
                });
                if (response.ok) {
                    try {
                        if (window.top !== window.self) {
                            window.parent.postMessage({ type: 'LOGOUT', data: { clear: true } }, '*');
                        } else {
                            // sessionStorage.removeItem('authToken');
                            // sessionStorage.removeItem('profilePhoto');
                            // sessionStorage.removeItem('username');
                            delete window.currentUserName;
                            delete window.currentUserName;
                            delete window.currentUserName;
                        }
                        // Show login again screen
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('sidebar').style.display = 'none';
                        document.getElementById('loginAgainScreen').style.display = 'block';
                    } catch (error) {
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('sidebar').style.display = 'none';
                        document.getElementById('loginAgainScreen').style.display = 'block';
                    }
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout. Please try again.');
            } finally {
                document.getElementById('loaderOverlay').style.display = 'none';
            }
        }

        async function showChangePassword() {
            const mainContent = document.getElementById('mainContent');
            document.getElementById('userDropdown').classList.remove('show');
            
            mainContent.innerHTML = `
                <div class="change-password-container">
                    <h1>Change Password</h1>
                       <input type="password" id="oldPassword" placeholder="Enter Old Password" required>
                        <input type="password" id="newPassword" placeholder="Enter New Password" required>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required>

                        <div>
                            <h2>Password Policy:</h2>
                            <ul>
                                <li><p>Between 8-16 characters</p></li>
                                <li><p>Include at least one upper case letter</p></li>
                                <li><p>Include at least one lower case letter</p></li>
                                <li><p>Include at least one numeric digit</p></li>
                                <li><p>Include at least one non-alphanumeric</p></li>
                                <li><p>Cannot contain a period(.), comma(,) or tilde(~)</p></li>
                            </ul>
                        </div>

                        <button onclick="handleChangePassword()" class="button-login">Change Password</button>
                        <div id="changePasswordError" style="color: #E94D35; margin-top: 10px; display: none;"></div>
                    </div>
                </div>
            `;
        }

        async function handleChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const errorDiv = document.getElementById('changePasswordError');

            errorDiv.style.display = 'none';

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmNewPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 8 || newPassword.length > 16 || 
                !/[A-Z]/.test(newPassword) || 
                !/[a-z]/.test(newPassword) || 
                !/[0-9]/.test(newPassword) || 
                !/[^a-zA-Z0-9]/.test(newPassword) || 
                /[.,~]/.test(newPassword)) {
                errorDiv.textContent = 'Password does not meet policy requirements';
                errorDiv.style.display = 'block';
                return;
            }

            // const token = sessionStorage.getItem('authToken');
            document.getElementById('loaderOverlay').style.display = 'flex';

            try {
                const token = window.currentAuthToken 
                // || sessionStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/auth/changepassword`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-api-version': '1.0',
                        'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        oldPassword,
                        newPassword
                    })
                });

                const result = await response.json();

                if (response.ok && result.status) {
                    // Clear the change password container
                    document.querySelector('.change-password-container').style.display = 'none';
                    
                    // Show success using the existing modal
                    const modal = document.getElementById('copyModal');
                    const overlay = document.getElementById('modalOverlay');
                    
                    modal.textContent = 'Password changed successfully!';
                    modal.style.display = 'block';
                    overlay.style.display = 'block';
                    
                    // Hide modal and logout after 2 seconds
                    setTimeout(() => {
                        modal.style.display = 'none';
                        overlay.style.display = 'none';
                        handleLogout();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Failed to change password');
                }
            } catch (error) {
                console.error('Change password error:', error);
                errorDiv.textContent = error.message || 'Failed to change password. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                document.getElementById('loaderOverlay').style.display = 'none';
            }
        }

        function forgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        // function loginAgain(){
        //    document.getElementById('loginAgain').style.display = 'none';
        // }

async function submitForgotPassword() {
    console.log("CLICKING");

    const username = document.getElementById('usernamef').value;
    console.log(username, "USERNAME");

    if (!username) {
        // document.getElementById('emptyUsername').style.display = 'block';
        showErrorModal("Please enter your Valid username") 
        return;
    }

    // document.getElementById('successMessage').style.display = 'none';
    // document.getElementById('emptyUsername').style.display = 'none';
    // document.getElementById('usernameNotFound').style.display = 'none';
    // document.getElementById('responseMessage').textContent = 'none';

    try {
        console.log("INSIDE TRY");

        // Anonymous login to get token
        const anonResponse = await fetch(`${API_BASE}/auth/anonymouslogin`, {
            method: 'POST',
            headers: {
                'Accept': 'text/plain',
                'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
            }
        });

        const anonData = await anonResponse.json();
        console.log(anonResponse, anonData, "ANON RESPONSE");

        if (!anonResponse.ok || !anonData?.data?.token) {
            throw new Error('Anonymous login failed');
        }

        document.getElementById('displayAnonToken').textContent = anonData.data.token;

        // Request password reset
        const resetResponse = await fetch(`${API_BASE}/auth/sendforgotpasswordcode?username=${encodeURIComponent(username)}`, {
            method: 'GET',
            headers: {
                'Accept': 'text/plain',
                'Ocp-Apim-Subscription-Key':  OCP_Sub_Key,
                'Authorization': `Bearer ${anonData.data.token}`,
            }
        });

        const resetData = await resetResponse.json();
        console.log(resetResponse.ok, resetData, "RESET RESPONSE");

        if (!resetResponse.ok) {
            // document.getElementById('usernameNotFound').style.display = 'block';
            showErrorModal("Username not found, Enter Valid Username") 
            throw new Error(resetData.message || 'Failed to process forgot password request');
        }

        if (resetData.status) {
            document.getElementById('successMessage').style.display = 'block';

            setTimeout(() => {
                document.getElementById('forgotPasswordForm').style.display = 'none';
                // document.getElementById('enterOTPForm').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        }

    } catch (error) {
        console.error("Error:", error);
        document.getElementById('responseMessage').textContent = error.message;
    }
}


function showErrorModal(message) {
    const modal = document.getElementById('errorModal');
    const errorMsg = document.getElementById('errorMessage');
    errorMsg.textContent = message;
    modal.style.display = 'block';
}

function closeErrorModal() {
    document.getElementById('errorModal').style.display = 'none';
}


        function addAgent() {
            document.getElementById('agentPopup').style.display = 'block';
            document.querySelector('.modal-overlay').style.display = 'block';
            document.getElementById('verifyEmailLink').classList.remove('hidden');
            document.getElementById('emailVerifiedText').classList.add('hidden');
            
            // Clear form
            document.getElementById('agentName').value = '';
            document.getElementById('agentNamef').value = '';
            document.getElementById('agentNamel').value = '';
            document.getElementById('agentPhone').value = '';
        }

        function closeAgentPopup() {
            document.getElementById('agentPopup').style.display = 'none';
            document.querySelector('.modal-overlay').style.display = 'none';
            document.getElementById('otpModal').classList.add('hidden');
        }

        // Email validation
        const emailInput = document.getElementById('agentName');
    const errorText = document.getElementById('emailError');

    emailInput.addEventListener('input', function () {
        const email = emailInput.value;
        if (email.includes('@') && email.includes('.com')) {
            errorText.style.display = 'none';
        } else {
            errorText.style.display = 'inline';
        }
    });

    function showEmailErrorModal() {
    document.getElementById('emailErrorModal').style.display = 'block';
}

function closeEmailErrorModal() {
    document.getElementById('emailErrorModal').style.display = 'none';
}

  let isEmailVerified = false;
async function verifyEmail() {
    const emailInput = document.getElementById('agentName');
    const emailId = emailInput.value.trim();

    if (!emailId.includes('@') || !emailId.includes('.com')) {
        showCommonAlertModal('Invalid Email', 'Please enter a valid email with @ and .com.');
        isEmailVerified = false;
        return;
    }

    document.getElementById('emailVerifiedText').classList.remove('hidden');
    isEmailVerified = true;

    try {
        const { response } = await apiRequest(`/user/verifyemail?emailId=${encodeURIComponent(emailId)}`, {
            method: 'POST',
            headers: { 'Accept': 'text/plain' },
            token: window.currentAuthToken
        });

        if (response.ok) {
            const otpModal = document.getElementById('otpModal');
            if (otpModal) otpModal.classList.remove('hidden');
            showCommonAlertModal('OTP Sent', 'An OTP has been sent to your email.');
        } else {
            showCommonAlertModal('Verification Failed', 'Failed to send verification email.');
        }
    } catch (error) {
        console.error('Error sending verification email:', error);
        showCommonAlertModal('Error', 'An error occurred while sending the verification email.');
    }
}



function showCommonAlertModal(title, message) {
    document.getElementById('commonAlertTitle').textContent = title || 'Alert';
    document.getElementById('commonAlertMessage').textContent = message || '';
    document.getElementById('commonAlertModal').style.display = 'block';
}

function closeCommonAlertModal() {
    document.getElementById('commonAlertModal').style.display = 'none';
}

        async function verifyOtp() {
            const otp = document.getElementById('otpInput').value.trim();
            
            if (!otp) {
                alert('Please enter OTP');
                return;
            }
        
            try {
                const { response } = await apiRequest(`/user/verifyotp?inputOtp=${encodeURIComponent(otp)}`, {
                    method: 'POST',
                    headers: { 'Accept': 'text/plain' },
                    // token: sessionStorage.getItem('authToken')
                    token: window.currentAuthToken
                });
        
                if (response.ok) {
                    // Close OTP modal
                    closeOtpModal();
                    
                    // Hide verify email link and show verified text
                    document.getElementById('verifyEmailLink').classList.add('hidden');
                    document.getElementById('emailVerifiedText').classList.remove('hidden');
                    
                    alert('Email verified successfully');
                } else {
                    alert('Invalid OTP');
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                alert('Error verifying OTP');
            }
        }
        
        function closeOtpModal() {
            document.getElementById('otpModal').classList.add('hidden');
            document.getElementById('otpInput').value = ''; // Clear OTP input
        }

          function handleActiveClick() {
    document.getElementById('activeBtn').classList.add('highlight');
    document.getElementById('activeBtn').classList.remove('dull');
    document.getElementById('deactiveBtn').classList.add('dull');
    document.getElementById('deactiveBtn').classList.remove('highlight');
    loadSubAgents();
  }

  function handleDeactiveClick() {
    document.getElementById('deactiveBtn').classList.add('highlight');
    document.getElementById('deactiveBtn').classList.remove('dull');
    document.getElementById('activeBtn').classList.add('dull');
    document.getElementById('activeBtn').classList.remove('highlight');
    loadDeactivatedAgents();
  }

    async function loadSubAgents(Action) {
        // document.getElementById("deactiveBtn").style.display= 'none';
        // document.getElementById("activeBtn").style.display= 'block';
    try {
        const token = window.currentAuthToken;
        const { response, data: result } = await apiRequest('/user/getall', {
            method: 'GET',
            headers: { 'Accept': 'text/plain',
             },
            token
        });

        if (response.ok && result.status && Array.isArray(result.data.list)) {
            // document.getElementById("deactiveBtn").style.display= 'block';
            // document.getElementById("activeBtn").style.display= 'none';
            const tbody = document.querySelector('#agentTable tbody');
            if (tbody) {
                tbody.innerHTML = '';
            } else {
                console.log("agentTable not found in DOM");
            }

            // Remove both buttons immediately
            const deactivateBtn = document.querySelector('.deactivate-btn');
            if (deactivateBtn) deactivateBtn.remove();

            const closeBtn = document.querySelector('.close-btn');
            if (closeBtn) closeBtn.remove();

            result.data.list.forEach(agent => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="clickable-username" data-username="${agent.userName}">${agent.userName || '-'}</td>
                    <td>${agent.name || '-'}</td>
                    
                    <td class="active-status">${agent.isActive === 2 ? 'Active' : 'Inactive'}</td>
                `;
                tbody.appendChild(row);

                const usernameCell = row.querySelector('.clickable-username');
                usernameCell.addEventListener('click', (event) => {
                    event.preventDefault();
                    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
                    row.classList.add('selected-row');

                    const selectedUsername = event.target.dataset.username;
                    console.log('Selected Username:', selectedUsername);

                    // Only show buttons if NOT closedBtn
                    if (Action !== "closedBtn") {
                        showDeactivateButton(selectedUsername);
                        showCloseButton(selectedUsername);
                    }
                });
            });
        }
    } catch (error) {
        console.error('Error fetching agents:', error);
    }
}

// async funcation navigetToDocumentation(){

// }


        function showDeactivateButton(username) {
            // Remove any existing deactivate button
            const existingBtn = document.querySelector('.deactivate-btn');
            if (existingBtn) {
                existingBtn.remove();
            }

            // Create and add the deactivate button above the table
            const tableContainer = document.getElementById('agentTable').parentElement;
            const deactivateBtn = document.createElement('button');
            deactivateBtn.className = 'deactivate-btn';
            deactivateBtn.innerHTML = 'Deactivate';
            deactivateBtn.onclick = () => showDeactivateModal(username);
            
            // Insert the button before the table
            tableContainer.insertBefore(deactivateBtn, document.getElementById('agentTable'));
        }

          function showCloseButton(username) {
            // Remove any existing close button
            const existingBtn = document.querySelector('.close-btn');
            console.log("existingBtn:", existingBtn);
            if (existingBtn) {
                existingBtn.remove();
            }

            // Create and add the close button above the table
            const tableContainer = document.getElementById('agentTable').parentElement;
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = 'Close';
            closeBtn.onclick = () => loadSubAgents("colsedBtn");
            
            // Insert the button before the table
            tableContainer.insertBefore(closeBtn, document.getElementById('agentTable'));
        }

        let userToDeactivate = null;

        function showDeactivateModal(username) {
            userToDeactivate = username;
            document.getElementById('deactivateModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function showReactivateModal(username) {
            userToDeactivate = username;
            document.getElementById('reactivateModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function closeDeactivateModal() {
            document.getElementById('deactivateModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            userToDeactivate = null;
        }

        function closeReactivateModal() {
            document.getElementById('reactivateModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            userToDeactivate = null;
        }
        

        async function confirmDeactivation() {
            if (!userToDeactivate) return;
            await deactivateUser(userToDeactivate);
            closeDeactivateModal();
        }

        async function confirmReactivation() {
            if (!userToDeactivate) return;
            await reactivateUser(userToDeactivate);
            closeReactivateModal();
        }

        async function deactivateUser(username) {
            // const token = sessionStorage.getItem('authToken');
            try {
                const token = window.currentAuthToken 
                // || sessionStorage.getItem('authToken');
                const { response } = await apiRequest(`/user/deactivate?username=${encodeURIComponent(username)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'text/plain' },
                    token
                });

                if (response.ok) {
                    alert(`User "${username}" has been deactivated.`);
                    loadSubAgents(); // Refresh the list
                } else {
                    alert(`Failed to deactivate "${username}"`);
                }
            } catch (error) {
                alert(`An error occurred while deactivating "${username}".`);
            }
        }

        async function loadDeactivatedAgents() {
            // const token = sessionStorage.getItem('authToken');
            // document.getElementById("deactiveBtn").style.display= 'block';
            // document.getElementById("activeBtn").style.display= 'none';
            try {
                const token = window.currentAuthToken 
                // || sessionStorage.getItem('authToken');
                const { response, data: result } = await apiRequest('/user/getall?status=4', {
                    method: 'GET',
                    // headers: { 'Accept': 'text/plain' },
                    headers: { 'Accept': 'text/plain',
             },
                    token
                });

                if (response.ok && result.status && Array.isArray(result.data.list)) {
                    // document.getElementById("deactiveBtn").style.display= 'none';
                    // document.getElementById("activeBtn").style.display= 'block';
                    const tbody = document.querySelector('#agentTable tbody');
                    tbody.innerHTML = '';
                    result.data.list.forEach(agent => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${agent.userName || '-'}</td>
                            <td>${agent.name || '-'}</td>
                           
                            <td>
                                <button class="reactivate-btn" onclick="showReactivateModal('${agent.userName}')">Reactivate</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    // <button class="reactivate-btn" onclick="reactivateUserModal('${agent.userName}')">Reactivate</button>
                    // <button class="reactivate-btn" onclick="reactivateUser('${agent.userName}')">Reactivate</button>

                    // Update heading and hide "View Deactivated Accounts" link
                    document.querySelector('#agentListContainer h2').textContent = 'Deactivated Agent Details';
                    document.querySelector('.view-deactivated').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching deactivated agents:', error);
            }
        }

        // function reactivateUserModal(username){
        //     showReactivateModal(username);
        // }

        async function reactivateUser() {
            // if (!confirm(`Are you sure you want to reactivate ${username}?`)) return;
        
            // const token = sessionStorage.getItem('authToken');
            try {
                const token = window.currentAuthToken 
                // || sessionStorage.getItem('authToken');
                const { response } = await apiRequest(`/user/activate?username=${encodeURIComponent(userToDeactivate)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'text/plain' },
                    token
                });

                if (response.ok) {
                    alert(`User "${userToDeactivate}" has been reactivated.`);
                    // Reset view and load active agents
                    document.querySelector('#agentListContainer h2').textContent = 'Agent Details';
                    document.querySelector('.view-deactivated').style.display = 'inline-block';
                    loadSubAgents();
                } else {
                    alert(`Failed to reactivate "${userToDeactivate}"`);
                }
            } catch (error) {
                alert(`An error occurred while reactivating "${userToDeactivate}".`);
            }
        }

        // async function submitAgentDetails() {
        //     const name = document.getElementById('agentNamef').value + ' ' + document.getElementById('agentNamel').value;
        //     const userName = document.getElementById('agentName').value;
        //     const emailId = document.getElementById('agentName').value;
        //     const contactNumber = document.getElementById('phoneNum').value;

        //     if (!document.getElementById('emailVerifiedText').classList.contains('hidden')) {
        //         alert('Please verify email first');
        //         return;
        //     }

        //     if (!name || !userName || !contactNumber) {
        //         alert('Please fill all required fields');
        //         return;
        //     }

        //     const requestBody = {
        //         name,
        //         userName,
        //         emailId,
        //         contactNumber
        //     };

        //     try {
        //         const { response, data: result } = await apiRequest('/user/addsubagent', {
        //             method: 'POST',
        //             headers: { 'Accept': 'text/plain' },
        //             // token: sessionStorage.getItem('authToken'),
        //             token: window.currentAuthToken,
        //             body: requestBody
        //         });

        //         if (response.ok) {
        //             document.getElementById('agentSuccessMessage').style.display = 'block';
        //             setTimeout(() => {
        //                 document.getElementById('agentSuccessMessage').style.display = 'none';
        //                 closeAgentPopup();
        //             }, 2000);
        //             loadSubAgents();
        //         } else {
        //             alert('Failed to add agent: ' + (result.message || 'Unknown error'));
        //         }
        //     } catch (error) {
        //         alert('An error occurred while adding the agent.');
        //     }
        // }

        //------------------------------------------
//        async function submitAgentDetails() {
//     const firstName = document.getElementById('agentNamef').value.trim();
//     const lastName = document.getElementById('agentNamel').value.trim();
//     const userName = document.getElementById('agentName').value.trim();
//     const emailId = userName;
//     const contactNumber = document.getElementById('phoneNum').value.trim();

//     const nameRegex = /^[A-Za-z]{2,32}$/;
//     const phoneRegex = /^(\d{8}|\d{10})$/;

//     // ✅ Safe check for email verification element
//     const emailVerifiedText = document.getElementById('emailVerifiedText');
//     if (!emailVerifiedText || emailVerifiedText.classList.contains('hidden')) {
//         showCommonAlertModal('Email Not Verified', 'Please verify the email before submitting.');
//         return;
//     }

//     // ✅ Validate first name
//     if (!firstName || !nameRegex.test(firstName)) {
//         showCommonAlertModal('Invalid First Name', 'First name must be 2 to 32 alphabetic characters.');
//         return;
//     }

//     // ✅ Validate last name
//     if (!lastName || !nameRegex.test(lastName)) {
//         showCommonAlertModal('Invalid Last Name', 'Last name must be 2 to 32 alphabetic characters.');
//         return;
//     }

//     // ✅ Validate phone number
//     if (!contactNumber || !phoneRegex.test(contactNumber)) {
//         showCommonAlertModal('Invalid Phone Number', 'Phone number must be exactly 8 or 10 digits.');
//         return;
//     }

//     // ✅ Validate email field
//     if (!userName) {
//         showCommonAlertModal('Missing Email', 'Please enter your email address.');
//         return;
//     }

//     const name = `${firstName} ${lastName}`;
//     const requestBody = {
//         name,
//         userName,
//         emailId,
//         contactNumber
//     };

//     try {
//         const { response, data: result } = await apiRequest('/user/addsubagent', {
//             method: 'POST',
//             headers: { 'Accept': 'text/plain' },
//             token: window.currentAuthToken,
//             body: requestBody
//         });

//         if (response.ok) {
//             document.getElementById('agentSuccessMessage').style.display = 'block';
//             setTimeout(() => {
//                 document.getElementById('agentSuccessMessage').style.display = 'none';
//                 closeAgentPopup();
//             }, 2000);
//             loadSubAgents();
//         } else {
//             showCommonAlertModal('Submission Failed', result.message || 'Unknown error occurred.');
//         }
//     } catch (error) {
//         console.error('Agent submission error:', error);
//         showCommonAlertModal('Error', 'An error occurred while adding the agent.');
//     }
// }

     

async function submitAgentDetails() {
    const firstName = document.getElementById('agentNamef').value.trim();
    const lastName = document.getElementById('agentNamel').value.trim();
    const userName = document.getElementById('agentName').value.trim();
    const emailId = userName;
    const contactNumber = document.getElementById('phoneNum').value.trim();

    const nameRegex = /^[A-Za-z]{2,32}$/;
    const phoneRegex = /^\d{8,10}$/;

    if (!isEmailVerified) {
        showCommonAlertModal('Email Not Verified', 'Please verify the email before submitting.');
        return;
    }

    if (!firstName || !nameRegex.test(firstName)) {
        showCommonAlertModal('Invalid First Name', 'First name must be 2 to 32 alphabetic characters.');
        return;
    }

    if (!lastName || !nameRegex.test(lastName)) {
        showCommonAlertModal('Invalid Last Name', 'Last name must be 2 to 32 alphabetic characters.');
        return;
    }

    if (!contactNumber || !phoneRegex.test(contactNumber)) {
        showCommonAlertModal('Invalid Phone Number', 'Phone number must be 8 to 10 digits and contain only numbers.');
        return;
    }

    if (!userName) {
        showCommonAlertModal('Missing Email', 'Please enter your email address.');
        return;
    }

    const name = `${firstName} ${lastName}`;
    const requestBody = {
        name,
        userName,
        emailId,
        contactNumber
    };

    try {
        const { response, data: result } = await apiRequest('/user/addsubagent', {
            method: 'POST',
            headers: { 'Accept': 'text/plain' },
            token: window.currentAuthToken,
            body: requestBody
        });

        if (response.ok) {
            document.getElementById('agentSuccessMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('agentSuccessMessage').style.display = 'none';
                closeAgentPopup();
            }, 2000);
            loadSubAgents();
        } else {
            showCommonAlertModal('Submission Failed', result.message || 'Unknown error occurred.');
        }
    } catch (error) {
        console.error('Agent submission error:', error);
        showCommonAlertModal('Error', 'An error occurred while adding the agent.');
    }
}

//         function showCommonAlertModal(title, message) {
//     document.getElementById('commonAlertTitle').textContent = title;
//     document.getElementById('commonAlertMessage').textContent = message;
//     document.getElementById('commonAlertModal').style.display = 'block';
// }

// function closeCommonAlertModal() {
//     document.getElementById('commonAlertModal').style.display = 'none';
// }


function showCommonAlertModal(title, message) {
    document.getElementById('commonAlertTitle').textContent = title;
    document.getElementById('commonAlertMessage').textContent = message;
    document.getElementById('commonAlertModal').style.display = 'block';
}

function closeCommonAlertModal() {
    document.getElementById('commonAlertModal').style.display = 'none';
}


        async function handleForcePasswordChange() {
            console.log("Forgot Change Password called");
            const tempPassword = document.getElementById('tempPasswordf').value;
            const newPassword = document.getElementById('newPasswordf').value;
            const confirmPassword = document.getElementById('confirmNewPasswordf').value;
            const username = document.getElementById('forceChangeUsername').textContent;
            const errorDiv = document.getElementById('forcePasswordError');

            if (!tempPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            // Password validation
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,16}$/;
            const invalidChars = /[.,~]/;

            if (!passwordRegex.test(newPassword)) {
                errorDiv.textContent = 'Password does not meet the requirements';
                errorDiv.style.display = 'block';
                return;
            }

            if (invalidChars.test(newPassword)) {
                errorDiv.textContent = 'Password cannot contain periods, commas, or tildes';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { response, data } = await apiRequest('/auth/forgotpassword', {
                    method: 'POST',
                    headers: { 'Accept': 'text/plain' },
                    body: {
                        username: username,
                        tempPassword: tempPassword,
                        newPassword: newPassword
                    }
                });

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to change password');
                }

                // Show success message and redirect to login
                alert('Password changed successfully! Please login with your new password.');
                window.location.reload();

            } catch (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = error.message || 'Failed to change password';
            }
        }

//         function showErrorModal(message) {
//     const modal = document.getElementById('errorModal');
//     const errorMsg = document.getElementById('errorMessage');
//     errorMsg.textContent = message;
//     modal.style.display = 'block';
// }

// function closeErrorModal() {
//     document.getElementById('errorModal').style.display = 'none';
// }

        async function forgotchangePassword() {
    const oldPassword = document.getElementById('oldPasswordf').value;
    const newPassword = document.getElementById('newPasswordf').value;
    const confirmPassword = document.getElementById('confirmNewPasswordf').value;
    const username = document.getElementById('usernamef').value;

    if (!oldPassword && !newPassword && !confirmPassword){
        showErrorModal('All Fields are Required');
        return;
    } 
    if (oldPassword && !newPassword && !confirmPassword) {
        showErrorModal('Enter New password & Confirm New Password');
        return;
    } 
    if (newPassword !== confirmPassword) {
        showErrorModal('Passwords do not match');
        return;
    }

    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,16}$/;
    const invalidChars = /[.,~]/;

    if (!passwordRegex.test(newPassword)) {
        showErrorModal('Password does not meet the requirements');
        return;
    }

    if (invalidChars.test(newPassword)) {
        showErrorModal('Password cannot contain periods, commas, or tildes');
        return;
    }

    try {
        const anonToken = document.getElementById('displayAnonToken').textContent;
        const { response, data } = await apiRequest('/auth/forgotpassword', {
            method: 'POST',
            headers: { 'Accept': 'text/plain' },
            token: anonToken,
            body: {
                username: username,
                tempPassword: oldPassword,
                newPassword: newPassword
            }
        });

        if (!response.ok) {
            throw new Error(data.message || 'Failed to change password');
        }

        document.getElementById('successPasswordChange').style.display = 'block';
        setTimeout(() => {
            document.getElementById('successPasswordChange').style.display = 'none';
            closeErrorModal();
            window.location.reload();
        }, 3000);

    } catch (error) {
        showErrorModal(error.message);
    }
}


//         async function forgotchangePassword() {
//             console.log("Forgot Change Password called");
//             const oldPassword = document.getElementById('oldPasswordf').value;
//             const newPassword = document.getElementById('newPasswordf').value;
//             const confirmPassword = document.getElementById('confirmNewPasswordf').value;
//             const username = document.getElementById('usernamef').value;

//             console.log(newPassword, typeof confirmPassword)

//             if (!oldPassword && !newPassword && !confirmPassword){
//                 console.log('old empty')
//                 document.getElementById('cpasswordErrorEmpty').style.display = 'block';
//                 document.getElementById('cpasswordErrorEmpty').textContent='All Fields are Required';
//             } 
//             if (oldPassword && !newPassword && !confirmPassword) {
//                 console.log('new and confirm empty')
//                 document.getElementById('cpasswordErrorEmpty').style.display = 'block';
//                 document.getElementById('cpasswordErrorEmpty').textContent='Enter New password & Confirm New Password';
//             } 
//             if (newPassword !== confirmPassword) {
//                 console.log('not match')
//                 document.getElementById('cpasswordError').style.display = 'block';
//                 document.getElementById('cpasswordError').textContent = 'Passwords do not match';
//                 return;
//             }

//             if (oldPassword && newPassword && confirmPassword) {
//                 // Password validation
//             const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,16}$/;
//             const invalidChars = /[.,~]/;

//             if (!passwordRegex.test(newPassword)) {
//                 console.log('Regx not match')
//                 document.getElementById('cpasswordError').style.display = 'block';
//                 document.getElementById('cpasswordError').textContent = 'Password does not meet the requirements';
//                 // document.getElementById('cpasswordError').textContent = 'Enter New password & Confirm New Password';
//                 return;
//             }

//              if (invalidChars.test(newPassword)) {
//                 document.getElementById('cpasswordError').style.display = 'block';
//                 document.getElementById('cpasswordError').textContent = 'Password cannot contain periods, commas, or tildes';
//                 return;
//             }

//              try {
//                 const anonToken = document.getElementById('displayAnonToken').textContent;
//                 const { response, data } = await apiRequest('/auth/forgotpassword', {
//                     method: 'POST',
//                     headers: { 'Accept': 'text/plain' },
//                     token: anonToken,
//                     body: {
//                         username: username,
//                         tempPassword: oldPassword,
//                         newPassword: newPassword
//                     }
//                 });

//                 console.log(response, data);

//                 if (!response.ok) {
//                     throw new Error(data.message || 'Failed to change password');
//                 }

//                 // Show success message and redirect to login
//                 // alert('Password changed successfully! Please login with your new password.');
//                 document.getElementById('successPasswordChange').style.display = 'block';
//                 setTimeout(() => {
//                     document.getElementById('successPasswordChange').style.display = 'none';
//                    window.location.reload();
//                 }, 3000);
//                 // window.location.reload();

//             } catch (error) {
//                 document.getElementById('cpasswordError').style.display = 'block';
//                 document.getElementById('cpasswordError').textContent = error.message;
//             }
//             }

// setTimeout(() => {
//     document.getElementById('cpasswordErrorEmpty').style.display = 'none';
//     document.getElementById('cpasswordError').style.display = 'none';
// }, 3000);
           
//         }

        window.addEventListener('message', function(event) {
            if (event.data.type === 'LOGIN_SUCCESS') {
                // Store the login data in the parent window's sessionStorage
                const loginData = event.data.data;
                // sessionStorage.setItem('authToken', loginData.token);
                // sessionStorage.setItem('profilePhoto', loginData.profilePhoto);
                // sessionStorage.setItem('username', loginData.username);
                // sessionStorage.setItem('apiKey', loginData.apiKey);
                window.currentAuthToken = loginData.token;
                window.currentProfilePhoto = loginData.profilePhoto;
                window.currentUserName = loginData.username;
                window.currentApiKey = loginData.apiKey;
                
                // Handle any other parent window updates needed
                console.log('Login data received and stored in parent window');
            }
        });
        // SPA: Login Again button handler
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('loginAgainBtn');
            if (btn) {
                btn.onclick = function() {
                    // Hide login again screen
                    document.getElementById('loginAgainScreen').style.display = 'none';
                    // Show only the original login form, hide all others for perfect CSS match
                    var loginForm = document.getElementById('loginForm');
                    var forgotPasswordForm = document.getElementById('forgotPasswordForm');
                    var enterOTPForm = document.getElementById('enterOTPForm');
                    var forcePasswordForm = document.getElementById('forcePasswordForm');
                    if (loginForm) {
                        // Reset all fields and errors
                        loginForm.reset && loginForm.reset();
                        Array.from(loginForm.querySelectorAll('input')).forEach(function(input) { input.value = ''; });
                        Array.from(loginForm.querySelectorAll('.error-message')).forEach(function(div) { div.style.display = 'none'; });
                        loginForm.style.display = 'flex';
                    }
                    if (forgotPasswordForm) forgotPasswordForm.style.display = 'none';
                    if (enterOTPForm) enterOTPForm.style.display = 'none';
                    if (forcePasswordForm) forcePasswordForm.style.display = 'none';
                };
            };
closeErrorModal();
            // loadSubAgents();
        });
    </script>
</body>
</html>
